/*! yet-another-coffescript-skeleton - v0.0.2 - last build: 2013-08-25 22:08:27 */
(function(){var n,e,t,r,i,o,l,u,a,f,c,s,h,g,p,d,v,m,b,w,x,y,k,F,z,M,E,I,j,C,R,q,A;A=false;c=function(n,e){if(e==null){e=A}if(e){console.log(n)}return n};u=function(n,e){if(e==null){e=A}if(e){$("body").append(n)}return n};e=function(n){$("body").append(n);return n};h=function(n,e,t,r,i){var o;if(t==null){t=0}if(r==null){r=0}if(i==null){i=0}o=Math.PI/180;e.save();e.translate(t,r);e.rotate(i*o);e.drawImage(n,-(n.width/2),-(n.height/2));e.restore();return true};b=function(n,e,t){return 3*n+4*e+t>>>3};r=function(n,e){var t,r;t=n.color;r=e.color;return b(t[0],t[1],t[2])-b(r[0],r[1],r[2])};s=function(n,e,t,r,i,o){if(t==null){t=0}if(r==null){r=0}if(i==null){i=0}if(o==null){o=false}if(o){h(FE.mirror(e.part),n,t,r,i)}else{h(e.part,n,t,r,i)}return true};F=function(n,e,t){var i,o;i=e.length;o=e.sort(r);return function(e,r,l,u,a,f){var c,h,g;if(u==null){u=0}if(a==null){a=false}c=b(e[0],e[1],e[2]);h=Math.floor(c/256*i);g=o[h];s(n,g,r*t,l*t,u,a);return[e,r,l,f]}};d=function(n){var e,t,r,i;i=n.width;t=n.height;r=[];e=function(n,e,t,o,l){var u;u=Math.floor(l/4);return r.push({y:Math.floor(u/i),x:Math.floor(u%i),color:[n,e,t,1],rotation:_.random(0,360),mirror:_.random(0,1)===0?false:true,pixel_nr:u})};FE.rgba(n,e,function(n){return null});return r};l=function(n,e){var t,r,i;if(e==null){e=100}if(n.width>=n.height){i=e;r=n.height*i/n.width}else{r=e;i=n.width*r/n.height}i=Math.floor(i);r=Math.floor(r);t=FE.pixelyResize(n,i,r);u(t);return[t,i,r]};o=function(n,e){var t,r,i,o,l,u;t=1-e;i=0;o=function(n){return i=i+n.part.width+n.part.height};for(l=0,u=n.length;l<u;l++){r=n[l];o(r)}i=Math.floor(i/(n.length*2)*t);return i};z=function(){return null};g=function(n,e,t,r,i,u){var a,f,s,h,g,p,v,m,b,w,$,x,y,k,M,E;if(t==null){t=.3}if(r==null){r=z}if(i==null){i=z}if(u==null){u=z}if(t>=1){t=.65}if(t<.2){t=.2}M=l(n,100),b=M[0],x=M[1],w=M[2];m=o(e,t);c("pixel_w_h: "+m);E=c(FE.newCanvasToolbox(x*m,w*m)),p=E[0],v=E[1];a=F(v,e,m);y=_.shuffle(d(b));$=y.length;s=10;r(p);h=0;g=0;k=Math.ceil(y.length/s);return(f=function(){var n,e,t;if(h>=$){return u(p)}else{e=function(n){var e;e=y[h+n];if(e){return a(e.color,e.x,e.y,e.rotation,e.mirror,h)}};for(n=t=0;0<=s?t<=s:t>=s;n=0<=s?++t:--t){e(n)}i(p,g,k);h=h+s;g=g+1;return requestAnimationFrame(f)}})()};i=function(n,e){var t,r;r=[];t=function(t,i){var o,l,a,f,c;if(i&&i.length===3){c=i[0],a=i[1],o=i[2];r.push({part:t,color:[c,a,o,1]})}else{f=FE.pixelyResize(t,1,1);l=function(n,e,i,o,l){return r.push({part:t,color:[n,e,i,1]})};FE.rgba(f,l,function(n){return null})}if(r.length===$(n).size()){_.each(r,function(n){u($('<div><span style="background-color:rgba('+n.color[0]+","+n.color[1]+","+n.color[2]+","+n.color[3]+')">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div>'));return u($(n.part))});return e(r)}};$(n).each(function(n){var e,r;e=false;r=$(this).attr("data-rgb");if(r){e=_.map(r.split(","),function(n){return parseInt(n)})}return FE.byImage(this,function(n){return t(n,e)})});return true};filepicker.setKey("ApeMsWqEOSBuCzqARVfHLz");p=[];n=.55;f=0;a=0;j=$("<canvas>").get(0);C=j.getContext("2d");w="veganizer-veganblatt";y=false;x=false;t=function(n){j.width=f;j.height=a;$("#post_file_select").hide();$("#step_by_step").show();return $("#step_veganized").html(j)};I=function(n,e,t){var r,i;C.drawImage(n,0,0,f,a);r=(e/t).toFixed(2);i=Math.floor(r*100);$("#progress").html(i+"%");return null};R=function(n,e,t,r){var i;if(t==null){t=function(n){return console.log(n)}}if(r==null){r=function(n){return console.log(n)}}console.log("in store canvas");console.log(n);i=n.toDataURL("image/jpeg").split(",",2)[1];return filepicker.store(i,{mimetype:"image/jpeg",base64decode:true},e,t,r)};v=function(n){console.log(n);return filepicker.exportFile(n,{suggestedFilename:w},function(n){return console.log(n)},function(n){return console.log(n)})};m=function(n){var e,t,r,i;console.log("finished");r=$("#veganblatt_logo").get(0);e=n.getContext("2d");e.drawImage(r,n.width-(r.width+15),n.height-(r.height+10));C.drawImage(n,0,0,f,a);$("#export").on("click",function(){if(y===false){return x=true}});i=function(n){var e;e="Save image (to disk, Fb, ...)";if(x){if(n<100){$("#export").attr("disabled","disabled");return $("#export").html(e+" "+n+"%")}else{return $("#export").html(e)}}};t=function(n){y=true;$("#export").on("click",function(){return v(n)});return $("#export").attr("disabled",false)};R(n,t,void 0,i);$("#finished_image").html(j);$("#step_by_step").hide();$("#finished").show();return null};E=function(n){var e,t,r,i,o,l;t=$(window).width()*.8;e=$(window).height()*.8;if(n.width>=t||n.height>=e){if(n.width>=n.height){l=t;o=n.height*l/n.width;if(o>e){r=e;i=l*r/o;o=r;l=i}}else{o=e;l=n.width*o/n.height;if(l>t){i=t;r=o*i/l;o=r;l=i}}n.width=l;n.height=o;console.log(n)}f=n.width;a=n.height;return n};k=function(e,r){var i,o,l,u;i=(e!=null?(l=e.filename)!=null?(u=l.match(/(.*)\.[^.]+$/))!=null?u[1]:void 0:void 0:void 0)||e.filename;if(i){w="veganblatt-"+i+"-veganizer"}o=new Image;o.addEventListener("load",function(){var e,r;console.log("dsfdsjhgdjlks");e=E(o);$("#call_to_action").hide();$("#to_veganize").html(e);$("#post_file_select").show();r=function(){console.log("start Veganize");return FE.byImage(e,function(e){return g(e,p,n,t,I,m)})};return $("#start_veganize").on("click",r)},false);return o.src="data:"+e.mimetype+";base64,"+r};M=function(){return filepicker.pick({mimetype:"image/*"},function(n){return filepicker.read(n,{base64encode:true},function(e){return k(n,e)},function(n){return console.log(n)})})};q=function(n){return console.log(n)};i(".parts",function(n){p=n;return $("#choose_image").on("click",M)})}).call(this);